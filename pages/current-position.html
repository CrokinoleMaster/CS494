<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Web Maps How-To</title><link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.4.2/pure.css"><!--[if lte IE 8]><link rel="stylesheet" href="css/layouts/side-menu-old-ie.css"><![endif]--><!--if gt IE 8--><link rel="stylesheet" href="/CS494/css/layouts/side-menu.css"><link rel="stylesheet" href="http://yandex.st/highlightjs/8.0/styles/tomorrow-night.min.css"><link rel="stylesheet" href="/CS494/css/main.css"><script src="http://yandex.st/highlightjs/8.0/highlight.min.js"></script><!--<![endif]--></head><body><div id="layout"><a id="menuLink" href="#menu" class="menu-link"><span></span></a><div id="menu"><div class="pure-menu pure-menu-open"><a href="#" class="pure-menu-heading">CONTENT</a><ul><li><a href="/CS494/index.html">Home</a></li><li><a href="/CS494/pages/algorithms.html">algorithms</a></li><li class="pure-menu-selected"><a href="/CS494/pages/current-position.html">current position</a></li><li><a href="/CS494/pages/track-distance.html">track distance</a></li><li><a href="/CS494/pages/leaflet-legends.html">leaflet legends</a></li><li><a href="/CS494/pages/getting-started.html">getting started</a></li><li><a href="/CS494/pages/libraries.html">libraries</a></li><li><a href="/CS494/pages/extra-credit.html">extra-credit</a></li></ul></div></div><div id="main"><div class="content"><h1>Current Position</h1>
<p>Displaying current position is not a difficult task. However, there are a few
important features missing in the Google Maps API. For one, it does not provide
a way to show which way the user is facing while using their mobile devices.
Developers are likely to not even consider the web platform when requiring features
like this, and simply choose native instead. But with a little work, we can
implement something that works the same with Javascript.</p>
<h3>Get set up</h3>
<p>We will use a small and light library for this guide to keep boilerplate to a
minimum.
<a href="http://hpneo.github.io/gmaps/" target="_blank">gmaps.js</a>
is what we will be using.
You should still be able to follow along even without it since the code is quite
self-explanatory.</p>
<p>Let&#39;s first add some boilerplate by creating a function to use as our demo app&#39;s
constructor and encapsulate our map object inside.</p>
<pre><code class="language-javascript">function App(){

    // here is our map object
    var map = new GMaps({div: &#39;#map&#39;,
                         lat: -12,
                         lng: -77,
                         mapType: &#39;SATALLITE&#39;});
}

// start our app when the DOM is ready
document.addEventListener(&#39;DOMContentLoaded&#39;, function() {
    var app = new App();
});</code></pre>
<p><strong><em>We will use JQuery from now on so we won&#39;t have to show that long document ready
line</em></strong></p>
<p>I kept the map object as a private variable because we should not need to directly
access it from the outside.</p>
<h3>Setting up a marker</h3>
<p>In order to have a current location marker, we have to first add a marker to the
map. We will use an arbitrary location for now. Later, when the geolocation
callback fires, we can update the marker.</p>
<pre><code class="language-javascript">// marker icon object
function App(){

    ...

    var currentMarkerIcon =  {path: google.maps.SymbolPath
                                          .FORWARD_CLOSED_ARROW,
                              scale: 4,
                              anchor: new google.maps.Point(0, 3),
                              strokeColor: &#39;#55efcb&#39;};

    // here we create a marker with the icon object at an arbitrary location
    var currentMarker = map.createMarker({ lat: -12, lng: -77, icon: currentMarkerIcon});
}</code></pre>
<p>Note that we are using a symbol rather than an image icon. This is because a
symbol is SVG, and simple to rotate. If you want to experiment, feel free to try
rotating an image icon, but it is off topic for this HOW-TO.</p>
<h3>Watching location</h3>
<p>Now we are ready to get our location and add our marker!</p>
<pre><code class="language-javascript">function App(){

    var app = this;

    ...

    // error callback function
    function errorCallback(){ ... }

    this.watchLocation = function() {
        map.addMarker(currentMarker);

        // here we are getting position every second. explanation below.
        window.setInterval(getPosition, 1000);

        function getPosition(){

            // calling the HTML5 geolocation method
            navigator.geolocation.getCurrentPosition(function(position){
              var lat = position.coords.latitude;
              var long = position.coords.longitude;

              // saving our position to a variable
              app.posCurrent = position;

              // set map center
              map.setCenter(lat, long);

              // update current marker position
              currentMarker.setPosition({lat: lat, lng: long});

              // triggering a custom JQuery event so we can manipulate the DOM
              // This is needed since the function is async
              $(app).trigger(&#39;move&#39;, [app.posCurrent]);

            }, errorCallback, { enableHighAccuracy: true });
        }
    };
}

$(function(){

    ...

    app.watchLocation();
});</code></pre>
<p>There are a couple things to mention here.</p>
<p>First, you might ask why we use <code>navigator.geolocation.getCurrentPosition</code>, rather
than <code>navigator.geolocation.watchPosition</code>. If we use <code>watchPosition</code>, we can omit
the <code>setInterval</code> method and it might be more efficient. You can certainly use
<code>watchPosition</code> instead.</p>
<p>However, from my experience <code>watchPosition</code> <strong>does not work</strong>
on devices with no Cellular connection. <em>What&#39;s worse is that it will cause all
other geolocation methods to stop working.</em> So currently, it is better to use
<code>getCurrentPosition</code> instead, and hope they will better implement these HTML5
features in browsers soon.</p>
<p>The JQuery custom event is used so that we could update the DOM when the location
callback is called. If you don&#39;t need to show the position, then of course you
wouldn&#39;t need this. If you are familiar with JQuery, this will be familar.
The code would look something like this:</p>
<pre><code class="language-javascript">$(function(){

    ...

    // helper function
    function formatPoint(point) {
        if (point){
          var str = &#39;lat: &#39; + point.coords.latitude.toFixed(5) +
                    &#39; long: &#39; + point.coords.longitude.toFixed(5);
          return str;
        }
    }

    // JQuery event handler
    $(app).on(&#39;move&#39;, function(e, posCurrent, /* other variables */) {
        $(&#39;#position&#39;).html(formatPoint(posCurrent));
    });

})</code></pre>
<h3>Getting compass heading</h3>
<p>Believe it or not, getting the compass heading is not that difficult with
Javascript. You can find the API for Chrome Android, and Safari Mobile quite
easily. We will make use of a small library so that our code is easier to read.
The library is
<a href="http://ai.github.io/compass.js/" target="_blank">compass.js</a>.
It&#39;s a little old,
so if you find that it&#39;s out of date, then you can try to contribute.</p>
<p>Let&#39;s add a function to our App object to start the compass heading listener.</p>
<pre><code class="language-javascript">function App(){

    ...

    // add a watchCompass function to our App constructor
    this.watchCompass = function() {

        // start listening to the compass
        Compass.watch(function(heading){

            // let&#39;s be cool and take device orientation into account
            if (window.orientation === 90){
                heading += 90;
            } else if (window.orientation === -90){
                heading -= 90;

            // upside down?? just in case someone is weird like that
            } else if (window.orientation === 180){
                heading += 180;
            }
              if (heading &gt; 360){
                heading-=360;
            }
            currentMarkerIcon.rotation = heading;
            currentMarker.set(&#39;icon&#39;, currentMarkerIcon);
        });
    }

    ...

}

$(function(){

    ...

    // call our method to start updating our Marker!
    app.watchCompass();

    ...

})</code></pre>
<p>This part couldn&#39;t have been any easier. Because we are using SVG markers,
rotation is as simple as changing the rotation property then updating the marker
icon. We also added orientation checks so that our app feels as good as native.</p>
<p>Try it out on your iPad/iPhone. Worked perfect on mine.</p>
<p><strong>compass.js did not work on my Nexus 5. Use the HTML5 orientation API directly
to see the results on android</strong></p>
</div></div></div><script>hljs.configure({tabReplace: '<span class="indent">\t</span>'})
hljs.initHighlightingOnLoad();</script></body></html>